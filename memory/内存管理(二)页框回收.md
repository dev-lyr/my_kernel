# 一概述:
## (1)背景:
- Linux在为用户态进程和内核分配动态内存时检查并不严格, 例如:对单个用户所创建的进程RAM使用总量并不严格限制(单个进程有限制);对内核使用的磁盘高速缓存和内存高速缓存的大小也同样不作限制.
- 当系统负载较低时, RAM大部分由磁盘高速缓存占用, 当前运行的进程会收益; 当系统负载增加时, RAM大部分由进程页占用, 高速缓存会缩小从而给其它进程让出空间.
- 当虚拟内存子系统压力很高时, 以至于所有内存耗尽, 此时交换区已满且磁盘高速缓存已被压缩, 没有进程可以继续执行, 针对这起情况会使用oom killer选择一个进程杀死并释放页框.

## (2)PFRA(页框回收算法, Page frame reclaiming algorithm):
- 采取从用户态进程和内核高速缓存回收页框的办法来补充伙伴系统的空闲块列表.
- 在所有空闲内存用完之前, 就必须执行PFRA.

# 二 选择目标页:
## (1)概述:
- PFRA根据页框包含内容不同, 以不同方式处理页框, 可分为: 不可回收页、可交换页、可同步页和可丢弃页.

## (2)不可回收页(无需也不能回收):
- 空闲页.
- 保留页(PG_reserved标志置位).
- 内核动态分配页.
- 进程内核态堆栈页.
- 临时锁定页(PG_locked标志置位).
- 内存锁定页(VM_LOCKED标记置位).

## (3)可交换页(交换分区):
- 用户态地址空间的匿名页: 进程用户态的堆和堆栈中的所有页为匿名页.
- tmpfs文件系统的映射页.

## (4)可同步页(必要时与磁盘映像同步):
- 用户态地址空间的映射页: 映射页指该页映射到一个文件的某个部分.
- 存有磁盘文件且在告诉缓存中的页.
- 块设备缓冲区页.
- 某些磁盘高速缓存的页(如索引节点高速缓存).
- 备注: 为回收页框, 内核需检查页是否为脏, 且必要时将页的内容写到相应磁盘文件.

## (5)可丢弃页(无需操作):
- 内存高速缓存中的未使用页.
- 目录项高速缓存的未使用页.

# 三 PFRA执行:
## (1)三种基本类型:
- 内存紧缺回收: 内核发现内存紧缺.
- 睡眠回收: 系统进入suspend-to-disk状态.
- 周期回收: 必要时周期性激活内核线程执行内核回收算法.

## (2)内存紧缺:
- grow_buffers(__getblk调用): 无法获得新的缓冲区页.
- alloc_page_buffers:无法获得页临时缓冲区首部.
- __alloc_pages: 无法在给定内存管理区分配一组连续的页框时.

## (3)周期性回收:
- kswap内核线程: 检查某个内存管理区中空闲页框数是否低于pages_high值.
- events内核线程: 预定义工作队列中的线程, PFRA周期性调用预定义工作队列中的一个任务执行, 从而回收slab分配器处理的位于内存告诉缓存中所有空闲slab.

# 四 LRU算法.